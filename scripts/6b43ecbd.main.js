var couchDbUserManagementApp=angular.module("couchDbUserManagementApp",["ngStorage",function(){}]);couchDbUserManagementApp.service("database",["$http","$q",function(a,b){"use strict";var c;return{setBaseUrl:function(a){c=a.replace(/\/$/,"")},checkSession:function(){var b=a({url:c+"/_session",withCredentials:!0});return b.then(function(a){var b=-1!==a.data.userCtx.roles.indexOf("_admin");if(b)return a.data.userCtx.name;throw new Error("not signed in.")})},signIn:function(b){var d=a({method:"post",url:c+"/_session",data:{name:b.username,password:b.password},withCredentials:!0});return d.then(function(){return b.username},function(a){var b=new Error(a.data.reason);throw b.name=a.data.error,b.status=a.data.status,b})},signOut:function(){var b=a({method:"delete",url:c+"/_session",withCredentials:!0});return b.catch(function(a){var b=new Error(a.data.reason);throw b.name=a.data.error,b.status=a.data.status,b})},getUsers:function(){var b=a({url:c+"/_users/_all_docs?include_docs=true&startkey=%22org.couchdb.user:%22&endkey=%22org.couchdb.user:|%22",withCredentials:!0});return b.then(function(a){return a.data.rows.map(function(a){return{username:a.doc.name,roles:a.doc.roles}})})},addUser:function(b){var d="org.couchdb.user:"+b.username,e=a({method:"put",url:c+"/_users/"+encodeURIComponent(d),data:{_id:d,name:b.username,password:b.password,roles:b.roles,type:"user"},withCredentials:!0});return e.then(function(){return delete b.password,b})},updateUser:function(d,e){var f="org.couchdb.user:"+d,g=this;return a({method:"get",url:c+"/_users/"+encodeURIComponent(f),withCredentials:!0}).then(function(h){var i=h.data;return i.roles=e.roles,e.password&&(i.password=e.password),e.username&&d!==e.username?(i._id="org.couchdb.user:"+e.username,delete i._rev,i.name=e.username,b.all([a({method:"put",url:c+"/_users/"+encodeURIComponent(i._id),data:i,withCredentials:!0}),g.removeUser(d)])):a({method:"put",url:c+"/_users/"+encodeURIComponent(f),data:i,withCredentials:!0})}).then(function(){return{username:e.username||d,roles:e.roles}})},removeUser:function(b){var d="org.couchdb.user:"+b;return a({method:"get",url:c+"/_users/"+encodeURIComponent(d),withCredentials:!0}).then(function(b){var e=b.data;return e._deleted=!0,a({method:"put",url:c+"/_users/"+encodeURIComponent(d),data:e,withCredentials:!0})}).then(function(){return b})}}}]),couchDbUserManagementApp.controller("AppCtrl",["$scope","$http","$localStorage","database",function(a,b,c,d){"use strict";a.couchDbUrl=c.couchDbUrl||"",a.username=c.username||"",d.setBaseUrl(a.couchDbUrl),a.$watch("currentUser",function(b){b?d.getUsers().then(function(b){a.users=b}).catch(function(a){window.alert("could not load users"),console.log(a)}):a.users=[]}),d.checkSession().then(function(b){a.currentUser=b,a.ready=!0}).catch(function(){a.ready=!0}),a.signIn=function(){c.couchDbUrl=a.couchDbUrl,c.username=a.username,d.setBaseUrl(a.couchDbUrl),d.signIn({username:a.username,password:a.password}).then(function(b){a.currentUser=b,a.password=""},function(b){a.signInError=b})},a.signOut=function(){d.signOut().then(function(){a.currentUser=void 0},function(a){window.alert("Something went wrong"),console.log(a)})},a.addUser=function(){a.newUserRoles||(a.newUserRoles=""),d.addUser({username:a.newUserUsername,password:a.newUserPassword,roles:a.newUserRoles.split(/\s*,\s*/)}).then(function(b){a.users=a.users.concat([b]).sort(function(a,b){return a.username>b.username?1:-1}),a.newUserUsername="",a.newUserPassword="",a.newUserRoles=""},function(b){a.newUserUsernameError=b})},a.cancelNewUser=function(){a.newUserUsername="",a.newUserPassword="",a.newUserRoles="",a.showNewUserForm=!1},a.toggleUser=function(b,c){a.openUser=a.isOpen(b)?null:b,c&&c.preventDefault()},a.updateUser=function(b){var c=b.newUsername&&b.username!==b.newUsername;d.updateUser(b.username,{username:b.newUsername,password:b.newPassword,roles:b.newRoles.split(/\s*,\s*/)}).then(function(d){b.username=d.username,b.newUsername=b.username,b.newPassword="",b.roles=d.roles.join(", "),b.newRoles=b.roles,window.alert("user updated"),c&&a.users.sort(function(a,b){return a.username>b.username?1:-1}),a.openUser=null},function(a){window.alert("something went wrong: "+a),console.log(a)})},a.removeUser=function(b,c){c.preventDefault(),window.confirm("Are you sure?")&&d.removeUser(b.username).then(function(){var c=a.users.indexOf(b);a.users.splice(c,1)},function(a){window.alert("something went wrong: "+a),console.log(a)})},a.isOpen=function(b){return a.openUser===b}}]),couchDbUserManagementApp.filter("highlight",["$sce",function(a){"use strict";return function(b,c){var d=b.match(/<a.*(?=<\/a>)<\/a>/,"gi");return d&&d.forEach(function(a,c){b=b.replace(new RegExp("("+a+")","i"),"§§"+c)}),c&&(b=b.replace(new RegExp("("+c+")","gi"),'<span class="highlighted">$1</span>')),d&&d.forEach(function(a,d){b=""!==c&&a.match(new RegExp("("+c+")","gi"))?b.replace("§§"+d,'<span class="highlighted">'+a+"</span>"):b.replace("§§"+d,a)}),a.trustAsHtml(b)}}]);