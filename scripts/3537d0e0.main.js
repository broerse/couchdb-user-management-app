var couchDbUserManagementApp=angular.module("couchDbUserManagementApp",["ngStorage",function(){}]);couchDbUserManagementApp.service("database",["$http",function(a){"use strict";return{checkSession:function(){var b=a({url:"http://localhost:5984/_session",withCredentials:!0});return b.then(function(a){var b=-1!==a.data.userCtx.roles.indexOf("_admin");if(b)return a.data.userCtx.name;throw new Error("not signed in.")})},signIn:function(b){var c=a({method:"post",url:"http://localhost:5984/_session",data:{name:b.username,password:b.password},withCredentials:!0});return c.then(function(){return b.username},function(a){var b=new Error(a.data.reason);throw b.name=a.data.error,b.status=a.data.status,b})},signOut:function(){var b=a({method:"delete",url:"http://localhost:5984/_session",withCredentials:!0});return b.catch(function(a){var b=new Error(a.data.reason);throw b.name=a.data.error,b.status=a.data.status,b})},getUsers:function(){var b=a({url:"http://localhost:5984/_users/_all_docs?include_docs=true&startkey=%22org.couchdb.user:%22&endkey=%22org.couchdb.user:|%22",withCredentials:!0});return b.then(function(a){return a.data.rows.map(function(a){return{username:a.doc.name,roles:a.doc.roles}})})},addUser:function(b){var c="org.couchdb.user:"+b.username,d=a({method:"put",url:"http://localhost:5984/_users/"+encodeURIComponent(c),data:{_id:c,name:b.username,password:b.password,roles:b.roles,type:"user"},withCredentials:!0});return d.then(function(){return delete b.password,b})},updateUser:function(b,c){var d="org.couchdb.user:"+c.username;return a({method:"get",url:"http://localhost:5984/_users/"+encodeURIComponent(d),withCredentials:!0}).then(function(e){var f=e.data;return f.roles=c.roles,c.password&&(f.password=c.password),c.username&&b!==c.username&&(window.alert("Username cannot be changed yet"),c.username=b),a({method:"put",url:"http://localhost:5984/_users/"+encodeURIComponent(d),data:f,withCredentials:!0})}).then(function(){return{username:c.username||b,roles:c.roles}})},removeUser:function(b){var c="org.couchdb.user:"+b;return a({method:"get",url:"http://localhost:5984/_users/"+encodeURIComponent(c),withCredentials:!0}).then(function(b){var d=b.data;return d._deleted=!0,a({method:"put",url:"http://localhost:5984/_users/"+encodeURIComponent(c),data:d,withCredentials:!0})}).then(function(){return b})}}}]),couchDbUserManagementApp.controller("AppCtrl",["$scope","$http","database",function(a,b,c){"use strict";a.couchDbUrl="http://0.0.0.0:5984",a.username="admin",a.password="",a.$watch("currentUser",function(b){b?c.getUsers().then(function(b){a.users=b}).catch(function(a){window.alert("could not load users"),console.log(a)}):a.users=[]}),c.checkSession().then(function(b){a.currentUser=b,a.ready=!0}).catch(function(){a.ready=!0}),a.signIn=function(){c.signIn({username:a.username,password:a.password}).then(function(b){a.currentUser=b,a.password=""},function(b){a.signInError=b})},a.signOut=function(){c.signOut().then(function(){a.currentUser=void 0},function(a){window.alert("Something went wrong"),console.log(a)})},a.addUser=function(){c.addUser({username:a.newUserUsername,password:a.newUserPassword,roles:a.newUserRoles.split(/\s*,\s*/)}).then(function(b){a.users=a.users.concat([b]).sort(function(a,b){return a.username>b.username?1:-1}),a.newUserUsername="",a.newUserPassword="",a.newUserRoles=""},function(b){a.newUserUsernameError=b})},a.cancelNewUser=function(){a.newUserUsername="",a.newUserPassword="",a.newUserRoles="",a.showNewUserForm=!1},a.toggleUser=function(b,c){a.openUser=a.isOpen(b)?null:b,c&&c.preventDefault()},a.updateUser=function(a){c.updateUser(a.username,{username:a.newUsername,password:a.newPassword,roles:a.newRoles.split(/\s*,\s*/)}).then(function(b){a.username=b.username,a.newUsername=a.username,a.newPassword="",a.roles=b.roles.join(", "),a.newRoles=a.roles,window.alert("user updated")},function(a){window.alert("something went wrong: "+a),console.log(a)})},a.removeUser=function(b,d){d.preventDefault(),window.confirm("Are you sure?")&&c.removeUser(b.username).then(function(){var c=a.users.indexOf(b);a.users.splice(c,1)},function(a){window.alert("something went wrong: "+a),console.log(a)})},a.isOpen=function(b){return a.openUser===b}}]),couchDbUserManagementApp.filter("highlight",["$sce",function(a){"use strict";return function(b,c){var d=b.match(/<a.*(?=<\/a>)<\/a>/,"gi");return d&&d.forEach(function(a,c){b=b.replace(new RegExp("("+a+")","i"),"§§"+c)}),c&&(b=b.replace(new RegExp("("+c+")","gi"),'<span class="highlighted">$1</span>')),d&&d.forEach(function(a,d){b=""!==c&&a.match(new RegExp("("+c+")","gi"))?b.replace("§§"+d,'<span class="highlighted">'+a+"</span>"):b.replace("§§"+d,a)}),a.trustAsHtml(b)}}]);